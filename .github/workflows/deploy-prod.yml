name: Deploy Prod

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Î∞∞Ìè¨Ìï† backend Î≤ÑÏ†Ñ (Ïòà: 1.2.3)'
        required: true
      deploy_slot:
        description: 'Blue/Green Ï§ë Ïñ¥Îäê Ïä¨Î°ØÏóê Î∞∞Ìè¨Ìï†ÏßÄ (Ïòà: blue, green)'
        required: true
        default: 'green'

jobs:
  create-template-and-mig:
    name: Create Template and MIG on GCP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Infra Repo
        uses: actions/checkout@v3

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set variables
        id: vars
        run: |
          VERSION=${{ github.event.inputs.version }}
          SLOT=${{ github.event.inputs.deploy_slot }}
          REGION="asia-northeast3"
          ZONE="asia-northeast3-a"
          TEMPLATE_NAME="onthetop-backend-${SLOT}-v${VERSION//./-}"
          MIG_NAME="onthetop-backend-${SLOT}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "slot=$SLOT" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "zone=$ZONE" >> $GITHUB_OUTPUT
          echo "template_name=$TEMPLATE_NAME" >> $GITHUB_OUTPUT
          echo "mig_name=$MIG_NAME" >> $GITHUB_OUTPUT

      - name: Clean up existing template/MIG if exists
        run: |
          TEMPLATE=${{ steps.vars.outputs.template_name }}
          MIG=${{ steps.vars.outputs.mig_name }}
          ZONE=${{ steps.vars.outputs.zone }}

          echo "üîç Checking if MIG exists..."
          gcloud compute instance-groups managed describe $MIG --zone=$ZONE >/dev/null 2>&1 && \
            gcloud compute instance-groups managed delete $MIG --zone=$ZONE --quiet || echo "‚úÖ MIG not found. Skipping delete."

          echo "üîç Checking if instance template exists..."
          gcloud compute instance-templates describe $TEMPLATE >/dev/null 2>&1 && \
            gcloud compute instance-templates delete $TEMPLATE --quiet || echo "‚úÖ Template not found. Skipping delete."

      - name: (Optional) Ensure Health Check Exists
        run: |
          gcloud compute health-checks describe http-health-check >/dev/null 2>&1 || \
          gcloud compute health-checks create http http-health-check \
            --port 8080 \
            --request-path=/api/v1/health \
            --check-interval=30s \
            --timeout=10s \
            --unhealthy-threshold=3 \
            --healthy-threshold=2

      - name: Create Instance Template
        run: |
          gcloud compute instance-templates create ${{ steps.vars.outputs.template_name }} \
            --machine-type=e2-small \
            --region=${{ steps.vars.outputs.region }} \
            --network-interface=subnet=onthetop-subnet-prod-private-server-a,no-address \
            --image=projects/ubuntu-os-cloud/global/images/ubuntu-minimal-2404-noble-amd64-v20250514 \
            --boot-disk-size=20GB \
            --service-account=213622576886-compute@developer.gserviceaccount.com \
            --scopes=https://www.googleapis.com/auth/cloud-platform \
            --tags=http-server,https-server,onthetop-monitoring-target,onthetop-server \
            --metadata=startup-version=${{ steps.vars.outputs.version }} \
            --metadata-from-file=startup-script=scripts/cicd/startup-script.sh

      - name: Create Managed Instance Group (MIG)
        run: |
          gcloud compute instance-groups managed create ${{ steps.vars.outputs.mig_name }} \
            --base-instance-name=${{ steps.vars.outputs.mig_name }} \
            --size=1 \
            --template=${{ steps.vars.outputs.template_name }} \
            --zone=${{ steps.vars.outputs.zone }} \
            --health-check=http-health-check \
            --initial-delay=180

      - name: Set Named Port for MIG
        run: |
          MIG=${{ steps.vars.outputs.mig_name }}
          ZONE=${{ steps.vars.outputs.zone }}

          gcloud compute instance-groups managed set-named-ports $MIG \
            --zone=$ZONE \
            --named-ports=http:8080

      - name: Wait for all MIG instances to become HEALTHY
        run: |
          MIG=${{ steps.vars.outputs.mig_name }}
          ZONE=${{ steps.vars.outputs.zone }}

          echo "‚è≥ Waiting for all instances in $MIG to become HEALTHY..."

          for i in {1..30}; do
            UNHEALTHY_COUNT=$(gcloud compute instance-groups managed list-instances $MIG \
              --zone=$ZONE \
              --format=json | jq '[.[] | select((.instanceHealth[0].detailedHealthState // "") != "HEALTHY")] | length')

            echo "Attempt $i: Unhealthy instance count = $UNHEALTHY_COUNT"

            if [ "$UNHEALTHY_COUNT" -eq 0 ]; then
              echo "‚úÖ All instances are HEALTHY!"
              exit 0
            fi

            sleep 15
          done

          echo "‚ùå Some instances did not become healthy in time"
          exit 1

      - name: Add MIG to Backend Service
        run: |
          MIG=${{ steps.vars.outputs.mig_name }}
          ZONE=${{ steps.vars.outputs.zone }}
          BACKEND_SERVICE="onthetop-backend-service"

          echo "üîÑ Replacing backend in $BACKEND_SERVICE with $MIG..."

          # ÏÉà MIG Ï∂îÍ∞Ä
          gcloud compute backend-services add-backend $BACKEND_SERVICE \
            --global \
            --instance-group=$MIG \
            --instance-group-zone=$ZONE

          MIG_URL="https://www.googleapis.com/compute/v1/projects/onthetop-457202/zones/$ZONE/instanceGroups/$MIG"

          echo "‚è≥ Waiting for LB to report $MIG as HEALTHY..."

          for i in {1..20}; do
            STATE=$(gcloud compute backend-services get-health $BACKEND_SERVICE --global --format=json |
              jq -r --arg MIG "$MIG_URL" '
                .[] | select(.backend == $MIG) |
                .status.healthStatus[0].healthState // "UNKNOWN"
              ' | tr -d '[:space:]')

            echo "Attempt $i: $MIG LB health = '$STATE'"

            if [ "$STATE" = "HEALTHY" ]; then
              echo "‚úÖ LB sees $MIG as healthy!"
              break
            fi

            sleep 15
          done

          if [ "$STATE" != "HEALTHY" ]; then
            echo "‚ùå LB never saw $MIG as healthy in time. Rolling back..."
            gcloud compute backend-services remove-backend $BACKEND_SERVICE \
              --global \
              --instance-group=$MIG \
              --instance-group-zone=$ZONE || true
            exit 1
          fi

          # üîÅ Í∏∞Ï°¥ MIG Ï†úÍ±∞
          echo "üßπ Removing old MIG from $BACKEND_SERVICE..."
          if [[ "$MIG" == *"blue" ]]; then
            OLD_MIG="onthetop-backend-green"
          else
            OLD_MIG="onthetop-backend-blue"
          fi

          gcloud compute backend-services remove-backend $BACKEND_SERVICE \
            --global \
            --instance-group=$OLD_MIG \
            --instance-group-zone=$ZONE || true
