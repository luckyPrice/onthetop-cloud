name: Confirm Prod Deployment (Clean Old Docker Slot)

# on:
#   workflow_dispatch:
#     inputs:

#       confirm_version:
#         description: 'í™•ì •í•  docker ë°°í¬ ë²„ì „ (ì˜ˆ: 1.2.3)'
#         required: true


on:
  push:
    branches:
      - feat/docker
jobs:
  confirm:
    runs-on: ubuntu-latest

    env:
      REGION: asia-northeast3

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set variables
        id: vars
        run: |
          REGION="${{ env.REGION }}"
      
          MIG_NAME="onthetop-mig-prod"
      
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "mig_name=$MIG_NAME" >> $GITHUB_OUTPUT

      - name: Get list of backend instance IPs
        id: get_ips
        run: |

          MIG="${{ steps.vars.outputs.mig_name }}"
          REGION="${{ steps.vars.outputs.region }}"
          INSTANCE_NAMES=$(gcloud compute instance-groups managed list-instances "$MIG" \
            --region="$REGION" \
            --format="get(instance)" | sed -n 's|.*/||p')
          
          if [ -z "$INSTANCE_NAMES" ]; then
            echo "âŒ MIG ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. MIG ì´ë¦„ê³¼ REGIONì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi


          ZONE_CANDIDATES=("asia-northeast3-a" "asia-northeast3-b" "asia-northeast3-c")

          IP_LIST=""
          for INSTANCE in $INSTANCE_NAMES; do
            for TRY_ZONE in "${ZONE_CANDIDATES[@]}"; do
              IP=$(gcloud compute instances describe "$INSTANCE" --zone "$TRY_ZONE" \
                --format="get(networkInterfaces[0].networkIP)" 2>/dev/null) || continue
              if [ -n "$IP" ]; then
                echo "âœ… $INSTANCE ($TRY_ZONE) â†’ $IP"
                IP_LIST+="$IP,"
                break
              fi
            done
          done

          IP_LIST="${IP_LIST%,}"

          echo " All IPs: $IP_LIST"
          echo "slot_ips=$IP_LIST" >> $GITHUB_OUTPUT

      - name: Set up SSH keys
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.JUMP_SSH_KEY }}" > ~/.ssh/jump_key
          chmod 600 ~/.ssh/jump_key

          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/dev_key
          chmod 600 ~/.ssh/dev_key


      - name: Confirm slot and remove old containers
        env:
            SLOT_IPS: ${{ steps.get_ips.outputs.slot_ips }}
            RAW_CONFIRM_VERSION: "1.0.2"
            # RAW_CONFIRM_VERSION: ${{ github.event.inputs.confirm_version }}
            JUMP_HOST: ${{ secrets.JUMP_SSH_HOST }}
        run: |
            CONFIRM_VERSION="v$RAW_CONFIRM_VERSION"
            mkdir -p ~/.ssh
            ssh-keyscan -H "$JUMP_HOST" >> ~/.ssh/known_hosts

            echo "ðŸ“¦ SLOT_IPS ê°’: $SLOT_IPS"
            IFS=',' read -ra IPS <<< "$SLOT_IPS"
            echo "ðŸ” ë¶„í•´ëœ IP ë°°ì—´: ${IPS[@]}"
            echo "ðŸ” ë°°ì—´ ê¸¸ì´: ${#IPS[@]}"

            for IP in "${IPS[@]}"; do
            echo "ðŸ§¹ Cleaning old slot on $IP..."

            ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o ProxyCommand="ssh -i ~/.ssh/jump_key -W %h:%p ubuntu@$JUMP_HOST" \
                -i ~/.ssh/dev_key ubuntu@$IP \
                CONFIRM_VERSION=$CONFIRM_VERSION bash -s <<'EOF'
                set -ex


                RUNNING_CONTAINERS=$(sudo docker ps --format '{{.Names}}' | grep '^onthetop-backend-' | wc -l)
                INSTANCE_NAME=$(hostname)
                SUMMARY+="[$INSTANCE_NAME] ðŸ”Ž ì²˜ìŒ ì‹¤í–‰ ì¤‘ ì»¨í…Œì´ë„ˆ ìˆ˜: $RUNNING_CONTAINERS\n"

                if [ "$RUNNING_CONTAINERS" -ne 2 ]; then
                echo "âŒ Error: '$INSTANCE_NAME' ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìˆ˜ê°€ $RUNNING_CONTAINERS ê°œìž…ë‹ˆë‹¤."
                sudo docker ps --format '  â†’ {{.Names}}  ({{.Status}})' | grep '^  â†’ onthetop-backend-' || true
                exit 1
                fi

                # 1. í˜„ìž¬ Nginxê°€ ë°”ë¼ë³´ëŠ” í¬íŠ¸ í™•ì¸
                ACTIVE_PORT=$(grep "proxy_pass" /etc/nginx/sites-enabled/backend | grep -oE '[0-9]+')

                # 2. ê° ìŠ¬ë¡¯ì˜ ë²„ì „ í™•ì¸
                BLUE_VERSION=$(sudo docker inspect --format='{{index .Config.Image}}' onthetop-backend-blue 2>/dev/null | cut -d: -f2 || echo "")
                GREEN_VERSION=$(sudo docker inspect --format='{{index .Config.Image}}' onthetop-backend-green 2>/dev/null | cut -d: -f2 || echo "")

                # 3. ACTIVE_PORT ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì œ Nginxê°€ ì‚¬ìš©í•˜ëŠ” ìŠ¬ë¡¯ ê²°ì •
                if [ "$ACTIVE_PORT" = "8080" ]; then
                  ACTIVE_SLOT=blue
                elif [ "$ACTIVE_PORT" = "8081" ]; then
                  ACTIVE_SLOT=green
                else
                  echo "âŒ Nginx ì„¤ì •ì—ì„œ í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                  exit 1
                fi

                # 4. Nginxê°€ ë°”ë¼ë³´ëŠ” ì»¨í…Œì´ë„ˆê°€ CONFIRM_VERSIONì¸ì§€ í™•ì¸
                ACTIVE_CONTAINER="onthetop-backend-$ACTIVE_SLOT"
                ACTIVE_VERSION=$(sudo docker inspect --format='{{index .Config.Image}}' "$ACTIVE_CONTAINER" 2>/dev/null | cut -d: -f2 || echo "")


                IS_RUNNING=$(sudo docker inspect -f '{{.State.Running}}' "$ACTIVE_CONTAINER" 2>/dev/null || echo "false")
                if [ "$IS_RUNNING" != "true" ]; then
                  echo "âŒ Error: Nginxê°€ ë°”ë¼ë³´ëŠ” ì»¨í…Œì´ë„ˆ '$ACTIVE_CONTAINER'ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤!"
                  sudo docker ps -a --format 'â†’ {{.Names}} ({{.Status}})' | grep onthetop-backend- || true
                  exit 1
                fi


                if [ "$ACTIVE_VERSION" != "$CONFIRM_VERSION" ]; then
                  echo "âŒ Error: Nginxê°€ ë°”ë¼ë³´ëŠ” ìŠ¬ë¡¯ $ACTIVE_SLOTì˜ ë²„ì „($ACTIVE_VERSION)ì´ CONFIRM_VERSION($CONFIRM_VERSION)ê³¼ ë‹¤ë¦…ë‹ˆë‹¤."
                  exit 1
                fi

                echo "âœ… Nginxê°€ ë°”ë¼ë³´ëŠ” ìŠ¬ë¡¯ '$ACTIVE_SLOT'ì˜ ë²„ì „ì´ CONFIRM_VERSION=$CONFIRM_VERSION ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ìŠ¬ë¡¯ì„ ì •ë¦¬í•©ë‹ˆë‹¤..."

                # 5. ë¶ˆí•„ìš”í•œ ìŠ¬ë¡¯ ì œê±°
                for SLOT in blue green; do
                  CONTAINER="onthetop-backend-$SLOT"
                  VERSION=$(sudo docker inspect --format='{{index .Config.Image}}' "$CONTAINER" 2>/dev/null | cut -d: -f2 || echo "")
                  if [ "$SLOT" = "$ACTIVE_SLOT" ]; then
                    echo "âœ… ìœ ì§€: $CONTAINER (version: $VERSION)"
                    SUMMARY+="[$INSTANCE_NAME] âœ… ìœ ì§€: $CONTAINER (version: $VERSION)\n"
                  elif [ "$VERSION" = "$CONFIRM_VERSION" ]; then
                    echo "ðŸ—‘ï¸ ì‚­ì œ: $CONTAINER (ë™ì¼ ë²„ì „ì´ì§€ë§Œ Nginxê°€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)"
                    # sudo docker rm -f "$CONTAINER"
                    SUMMARY+="[$INSTANCE_NAME] ðŸ—‘ï¸ ì‚­ì œ: $CONTAINER (ë™ì¼ ë²„ì „ì´ì§€ë§Œ ë¹„í™œì„±)\n"
                  elif [ -n "$VERSION" ]; then
                    echo "ðŸ—‘ï¸ ì‚­ì œ: $CONTAINER (version: $VERSION â‰  $CONFIRM_VERSION)"
                    # sudo docker rm -f "$CONTAINER"
                    SUMMARY+="[$INSTANCE_NAME] ðŸ—‘ï¸ ì‚­ì œ: $CONTAINER (version: $VERSION)\n"
                  else
                    echo "âŽ ì¡´ìž¬í•˜ì§€ ì•ŠìŒ: $CONTAINER"
                    SUMMARY+="[$INSTANCE_NAME] âŽ ì¡´ìž¬í•˜ì§€ ì•ŠìŒ: $CONTAINER\n"
                  fi
                done
                

                echo -e "\nðŸ“‹ [$INSTANCE_NAME] ì»¨í…Œì´ë„ˆ ì •ë¦¬ ìš”ì•½:"
                echo -e "$SUMMARY"
            EOF
            done

      - name: Update confirmed version in GCP Secret Manager
        env:
            CONFIRM_VERSION: ${{ github.event.inputs.confirm_version }}
        run: |
          echo -n "$CONFIRM_VERSION" > be-version.txt
          gcloud secrets versions add confirmed-backend-version --data-file=be-version.txt