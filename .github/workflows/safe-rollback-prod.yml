name: Rollback Prod (Safe)

on:
  workflow_dispatch:
    inputs:
      be_slot:
        description: 'í˜„ìž¬ ìž˜ëª» ë°°í¬ëœ BE ìŠ¬ë¡¯ (ì˜ˆ: blue, green)'
        required: true
      fe_slot:
        description: 'í˜„ìž¬ ìž˜ëª» ë°°í¬ëœ FE ìŠ¬ë¡¯ (ì˜ˆ: blue, green)'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    env:
      REGION: asia-northeast3
      ZONE: asia-northeast3-a
      BACKEND_SERVICE: onthetop-backend-service
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      AWS_DEFAULT_REGION: ap-northeast-2

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.CLOUDFRONT_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.CLOUDFRONT_SECRET_KEY }}
          aws-region: ap-northeast-2

      - name: Rollback Backend with MIG Health Check
        run: |
          SLOT="${{ github.event.inputs.be_slot }}"
          if [[ "$SLOT" == "blue" ]]; then
            TARGET="green"
          else
            TARGET="blue"
          fi

          NEW_MIG="onthetop-backend-$TARGET"
          OLD_MIG="onthetop-backend-$SLOT"
          PROJECT=$(gcloud config get-value project)

          echo "ðŸ” $TARGET MIG ì¸ìŠ¤í„´ìŠ¤ ê·¸ë£¹ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          for i in {1..20}; do
            STATUS=$(gcloud compute instance-groups managed list-instances "$NEW_MIG" \
              --zone="$ZONE" --format=json | \
              jq -r 'map(.instanceStatus) | unique | .[]')

            echo "â³ ì‹œë„ $i: ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ = $STATUS"
            [[ "$STATUS" == "RUNNING" ]] && break
            sleep 10
          done

          if [[ "$STATUS" != "RUNNING" ]]; then
            echo "âŒ MIG ì¸ìŠ¤í„´ìŠ¤ ê·¸ë£¹ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡¤ë°± ì¤‘ë‹¨."
            exit 1
          fi

          echo "âœ… MIG ì¸ìŠ¤í„´ìŠ¤ ê·¸ë£¹ ì¤€ë¹„ ì™„ë£Œ. ë°±ì—”ë“œì— ì—°ê²° ì¤‘..."
          gcloud compute backend-services add-backend "$BACKEND_SERVICE" \
            --global \
            --instance-group="$NEW_MIG" \
            --instance-group-zone="$ZONE"

          echo "ðŸ” LB to MIG í—¬ìŠ¤ì²´í¬ í™•ì¸ ì¤‘..."
          MIG_URL="https://www.googleapis.com/compute/v1/projects/$PROJECT/zones/$ZONE/instanceGroups/$NEW_MIG"

          for i in {1..20}; do
            STATE=$(gcloud compute backend-services get-health "$BACKEND_SERVICE" --global --format=json | \
              jq -r --arg MIG "$MIG_URL" \
                '.[] | select(.backend == $MIG) | (.status.healthStatus // []) | map(.healthState) | unique | .[]?')

            echo "â³ ì‹œë„ $i: ìƒíƒœ = $STATE"
            [[ "$STATE" == "HEALTHY" ]] && break
            sleep 10
          done

          if [[ "$STATE" != "HEALTHY" ]]; then
            echo "âŒ HEALTHY ìƒíƒœê°€ ì•„ë‹˜. ë¡¤ë°± ì¤‘ë‹¨."
            exit 1
          fi

          echo "âœ… HEALTHY ìƒíƒœ í™•ì¸ë¨. ë¡¤ë°± ì§„í–‰."
          gcloud compute backend-services remove-backend "$BACKEND_SERVICE" \
            --global \
            --instance-group="$OLD_MIG" \
            --instance-group-zone="$ZONE" || true

          echo "ðŸ§¹ $OLD_MIG ì‚­ì œ ì¤‘..."
          gcloud compute instance-groups managed delete "$OLD_MIG" --zone="$ZONE" --quiet || true

      - name: Rollback CloudFront FE Origin
        run: |
          SLOT="${{ github.event.inputs.fe_slot }}"
          if [[ "$SLOT" == "blue" ]]; then
            TARGET="green"
          else
            TARGET="blue"
          fi

          echo "ðŸ”„ FE ìŠ¬ë¡¯ì„ $TARGET ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤."
          aws cloudfront get-distribution-config --id "$CLOUDFRONT_DISTRIBUTION_ID" > raw.json

          ETAG=$(jq -r '.ETag' raw.json)
          jq '.DistributionConfig' raw.json > config-only.json

          jq --arg TARGET "$TARGET" \
            '.Origins.Items[0].OriginPath = "/frontend/prod/\($TARGET)"' \
            config-only.json > updated-config.json

          aws cloudfront update-distribution \
            --id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --if-match "$ETAG" \
            --distribution-config file://updated-config.json

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths "/" "/index.html" "/assets/*.js" "/assets/*.css"
